<api context="/hospital" name="PatientRegistrationAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" uri-template="/register">
        <inSequence>
            <log category="INFO">
                <message>Received patient registration request</message>
            </log>
            
            <!-- Validate JSON payload -->
            <filter xpath="${exists(payload)}">
                <then>
                    <log category="INFO">
                        <message>Valid patient registration data received</message>
                    </log>
                    
                    <!-- Generate a unique ID for the registration -->
                    <variable name="registrationId" expression="${utility.string.UUID()}" type="STRING"/>
                    
                    <!-- Create a timestamp -->
                    <variable name="timestamp" expression="${now()}" type="STRING"/>
                    
                    <!-- Enhance the payload with metadata -->
                    <payloadFactory media-type="json">
                        <format>
                            {
                                "registrationId": "${vars.registrationId}",
                                "timestamp": "${vars.timestamp}",
                                "patientData": ${payload}
                            }
                        </format>
                    </payloadFactory>
                    
                    <!-- Publish to JMS queue -->
                    <jms.publishMessage configKey="JMS_CONNECTION">
                        <destination>PatientRegistrationQueue</destination>
                        <messageType>application/json</messageType>
                    </jms.publishMessage>
                    
                    <!-- Send success response back to client -->
                    <payloadFactory media-type="json">
                        <format>
                            {
                                "status": "success",
                                "message": "Patient registration submitted successfully",
                                "registrationId": "${vars.registrationId}"
                            }
                        </format>
                    </payloadFactory>
                    <respond/>
                </then>
                <else>
                    <!-- Return error if payload is invalid -->
                    <payloadFactory media-type="json">
                        <format>
                            {
                                "status": "error",
                                "message": "Invalid patient registration data"
                            }
                        </format>
                    </payloadFactory>
                    <respond/>
                </else>
            </filter>
        </inSequence>
        <faultSequence>
            <payloadFactory media-type="json">
                <format>
                    {
                        "status": "error",
                        "message": "An error occurred while processing the registration"
                    }
                </format>
            </payloadFactory>
            <respond/>
        </faultSequence>
    </resource>
</api>
